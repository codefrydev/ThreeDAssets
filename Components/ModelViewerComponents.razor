@if (Model is not null && IsVisible)
{
    <div class="fixed inset-0 bg-theme-overlay backdrop-blur-sm z-50 flex flex-col"
         @onclick="ClosePopup">
        <div class="flex-1 flex flex-col min-h-0 max-h-screen" @onclick:stopPropagation="true">
            <!-- Thin top bar: title + close -->
            <div class="flex-shrink-0 flex items-center justify-between px-4 py-2 bg-theme-primary border-b border-theme-primary">
                <h2 class="text-lg font-semibold text-theme-primary truncate">@Model.AltText</h2>
                <button @onclick="ClosePopup"
                        class="p-2 rounded-lg text-theme-secondary hover:text-theme-primary hover:bg-theme-secondary transition-colors"
                        aria-label="Close">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>

            <!-- Viewer + right sidebar (Sketchfab-style controls) -->
            <div class="flex-1 flex min-h-0">
                <div class="flex-1 min-w-0 min-h-0 flex flex-col bg-theme-secondary">
                    <div class="flex-1 min-h-0 rounded-none">
                        <ThreeDModelViewer ViewerId="model-viewer-modal" Model="Model" Options="Options" FillContainer="true"></ThreeDModelViewer>
                    </div>
                </div>

                <aside class="flex-shrink-0 w-80 border-l border-theme-primary bg-theme-primary overflow-y-auto">
                    <div class="p-4 space-y-5">
                        <!-- Model -->
                        <section>
                            <h3 class="text-xs font-semibold text-theme-muted uppercase tracking-wide mb-2">Model</h3>
                            <p class="text-theme-primary font-medium text-sm">@Model.AltText</p>
                        </section>

                        <!-- Camera -->
                        <section class="pt-2 border-t border-theme-primary">
                            <h3 class="text-xs font-semibold text-theme-muted uppercase tracking-wide mb-3">Camera</h3>
                            <div class="space-y-2.5 text-sm">
                                <label class="flex items-center gap-2 cursor-pointer">
                                    <InputCheckbox @bind-Value="Model.CameraControls" class="w-4 h-4 text-theme-accent" />
                                    <span class="text-theme-primary">Camera controls</span>
                                </label>
                                <label class="flex items-center gap-2 cursor-pointer">
                                    <InputCheckbox @bind-Value="Model.AutoRotate" class="w-4 h-4 text-theme-accent" />
                                    <span class="text-theme-primary">Auto rotate</span>
                                </label>
                            </div>
                        </section>

                        <!-- Display -->
                        <section class="pt-2 border-t border-theme-primary">
                            <h3 class="text-xs font-semibold text-theme-muted uppercase tracking-wide mb-3">Display</h3>
                            <div class="space-y-3 text-sm">
                                <div>
                                    <label class="text-theme-muted block text-xs mb-1">Shadow intensity</label>
                                    <input type="range" min="0" max="2" step="0.1" @bind="Model.ShadowIntensity"
                                           class="w-full h-2 bg-theme-tertiary rounded appearance-none [&::-webkit-slider-thumb]:bg-theme-accent [&::-webkit-slider-thumb]:rounded-full [&::-webkit-slider-thumb]:h-3 [&::-webkit-slider-thumb]:w-3" />
                                </div>
                                <div>
                                    <label class="text-theme-muted block text-xs mb-1">Shadow softness</label>
                                    <input type="range" min="0" max="1" step="0.1" @bind="Model.ShadowSoftness"
                                           class="w-full h-2 bg-theme-tertiary rounded appearance-none [&::-webkit-slider-thumb]:bg-theme-accent [&::-webkit-slider-thumb]:rounded-full [&::-webkit-slider-thumb]:h-3 [&::-webkit-slider-thumb]:w-3" />
                                </div>
                                <div>
                                    <label class="text-theme-muted block text-xs mb-1">Exposure</label>
                                    <input type="range" min="0" max="2" step="0.1" @bind="Model.Exposure"
                                           class="w-full h-2 bg-theme-tertiary rounded appearance-none [&::-webkit-slider-thumb]:bg-theme-accent [&::-webkit-slider-thumb]:rounded-full [&::-webkit-slider-thumb]:h-3 [&::-webkit-slider-thumb]:w-3" />
                                </div>
                                @if (Options?.ToneMappings?.Count > 0)
                                {
                                    <div>
                                        <label class="text-theme-muted block text-xs mb-1">Tone mapping</label>
                                        <select @bind="Model.ToneMapping" class="w-full px-2 py-1.5 text-sm border border-theme-primary rounded bg-theme-secondary text-theme-primary">
                                            @foreach (var item in Options.ToneMappings)
                                            {
                                                <option value="@item">@item</option>
                                            }
                                        </select>
                                    </div>
                                }
                            </div>
                        </section>

                        <!-- Environment -->
                        <section class="pt-2 border-t border-theme-primary">
                            <h3 class="text-xs font-semibold text-theme-muted uppercase tracking-wide mb-3">Environment</h3>
                            <div class="space-y-3 text-sm">
                                @if (Options?.EnvironmentImages?.Count > 0)
                                {
                                    <div>
                                        <label class="text-theme-muted block text-xs mb-1">Environment image</label>
                                        <select @bind="Model.EnvironmentImage" class="w-full px-2 py-1.5 text-sm border border-theme-primary rounded bg-theme-secondary text-theme-primary">
                                            <option value="">Default</option>
                                            @foreach (var url in Options.EnvironmentImages)
                                            {
                                                <option value="@url">@(url.Length > 45 ? url.Substring(0, 42) + "…" : url)</option>
                                            }
                                        </select>
                                    </div>
                                }
                                @if (Options?.SkyboxImages?.Count > 0)
                                {
                                    <div>
                                        <label class="text-theme-muted block text-xs mb-1">Skybox image</label>
                                        <select @bind="Model.SkyboxImage" class="w-full px-2 py-1.5 text-sm border border-theme-primary rounded bg-theme-secondary text-theme-primary">
                                            @foreach (var url in Options.SkyboxImages)
                                            {
                                                <option value="@url">@(url.Length > 45 ? url.Substring(0, 42) + "…" : url)</option>
                                            }
                                        </select>
                                    </div>
                                }
                                @if (Options?.SkyboxHeights?.Count > 0)
                                {
                                    <div>
                                        <label class="text-theme-muted block text-xs mb-1">Skybox height</label>
                                        <select @bind="Model.SkyboxHeight" class="w-full px-2 py-1.5 text-sm border border-theme-primary rounded bg-theme-secondary text-theme-primary">
                                            @foreach (var h in Options.SkyboxHeights)
                                            {
                                                <option value="@h">@h</option>
                                            }
                                        </select>
                                    </div>
                                }
                            </div>
                        </section>

                        <!-- Animation -->
                        @if (Options?.AnimationNames?.Count > 0)
                        {
                            <section class="pt-2 border-t border-theme-primary">
                                <h3 class="text-xs font-semibold text-theme-muted uppercase tracking-wide mb-2">Animation</h3>
                                <select @bind="Model.AnimationName" class="w-full px-2 py-1.5 text-sm border border-theme-primary rounded bg-theme-secondary text-theme-primary">
                                    @foreach (var item in Options.AnimationNames)
                                    {
                                        <option value="@item">@item</option>
                                    }
                                </select>
                            </section>
                        }

                        <!-- AR -->
                        <section class="pt-2 border-t border-theme-primary">
                            <h3 class="text-xs font-semibold text-theme-muted uppercase tracking-wide mb-2">AR</h3>
                            <label class="flex items-center gap-2 cursor-pointer text-sm">
                                <InputCheckbox @bind-Value="Model.EnableAr" class="w-4 h-4 text-theme-accent" />
                                <span class="text-theme-primary">Enable AR</span>
                            </label>
                        </section>

                        <!-- Actions / help -->
                        <section class="pt-2 border-t border-theme-primary">
                            <h3 class="text-xs font-semibold text-theme-muted uppercase tracking-wide mb-2">Actions</h3>
                            <p class="text-xs text-theme-muted">Use the fullscreen icon on the viewer for fullscreen. AR is available when supported by your device.</p>
                        </section>

                        <!-- Details (collapsible) -->
                        <section class="pt-2 border-t border-theme-primary">
                            @if (_showDetails)
                            {
                                <button type="button" @onclick="() => _showDetails = false" class="text-sm font-medium text-theme-accent mb-2">Hide details</button>
                                <div class="text-xs text-theme-secondary space-y-1 break-all">
                                    <p><span class="text-theme-muted">Source:</span> @Model.Source</p>
                                    <p><span class="text-theme-muted">Poster:</span> @Model.Poster</p>
                                </div>
                            }
                            else
                            {
                                <button type="button" @onclick="() => _showDetails = true" class="text-sm font-medium text-theme-accent">Show details</button>
                            }
                        </section>
                    </div>
                </aside>
            </div>
        </div>
    </div>
}
